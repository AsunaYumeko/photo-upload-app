#:kivy 2.0

<MainScreen>:
    name: 'main'
    BoxLayout:
        orientation: 'vertical'
        padding: dp(15)
        spacing: dp(20)
        
        # Header - 标题和设置按钮
        BoxLayout:
            size_hint_y: None
            height: dp(70)
            spacing: dp(80)
            canvas.before:
                Color:
                    rgba: 0.2, 0.2, 0.2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: '拍照签收'
                font_name: 'Chinese'
                font_size: '18sp'
                size_hint_x: 0.5
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                canvas.before:
                    Color:
                        rgba: 0.2, 0.2, 0.2, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
            
            Widget:
                size_hint_x: 0.15
            
            Button:
                text: '设置'
                font_name: 'Chinese'
                size_hint_x: 0.35
                font_size: '18sp'
                on_release: app.root.current = 'settings'
                background_color: 0.5, 0.5, 0.5, 1
        
        # Task List Header - 任务列表和刷新按钮
        BoxLayout:
            size_hint_y: None
            height: dp(70)
            spacing: dp(80)
            canvas.before:
                Color:
                    rgba: 0.25, 0.25, 0.25, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: '任务列表'
                font_name: 'Chinese'
                font_size: '18sp'
                size_hint_x: 0.5
                text_size: self.size
                halign: 'left'
                valign: 'middle'
                canvas.before:
                    Color:
                        rgba: 0.25, 0.25, 0.25, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
            
            Widget:
                size_hint_x: 0.15
            
            Button:
                text: '刷新'
                font_name: 'Chinese'
                size_hint_x: 0.35
                font_size: '18sp'
                on_release: root.refresh_tasks()
                background_color: 0.2, 0.6, 1, 1
        
        # Task List Container - 使用比例布局
        BoxLayout:
            size_hint_y: 0.35
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            ScrollView:
                do_scroll_x: False
                bar_width: 8
                BoxLayout:
                    id: task_container
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
        
        # Current Order Info - with background to prevent overlap
        BoxLayout:
            size_hint_y: None
            height: dp(65)
            canvas.before:
                Color:
                    rgba: 0.1, 0.1, 0.1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                id: order_label
                text: '订单: 无'
                font_name: 'Chinese'
                font_size: '16sp'
                size_hint_x: 0.5
                text_size: self.size
                halign: 'center'
                valign: 'middle'
                canvas.before:
                    Color:
                        rgba: 0.1, 0.1, 0.1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
            
            Label:
                id: photo_count_label
                text: '照片: 0'
                font_name: 'Chinese'
                font_size: '16sp'
                size_hint_x: 0.5
                text_size: self.size
                halign: 'center'
                valign: 'middle'
                canvas.before:
                    Color:
                        rgba: 0.1, 0.1, 0.1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
        
        # Photo Preview - 可滑动查看多张照片
        BoxLayout:
            size_hint_y: 0.38
            canvas.before:
                Color:
                    rgba: 0.85, 0.85, 0.85, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            ScrollView:
                do_scroll_x: False
                bar_width: 8
                BoxLayout:
                    id: photo_container
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
        
        # Status
        BoxLayout:
            size_hint_y: None
            height: dp(60)
            canvas.before:
                Color:
                    rgba: 0.1, 0.15, 0.1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                id: status_label
                text: '请选择任务'
                font_name: 'Chinese'
                font_size: '15sp'
                color: 0.4, 1, 0.4, 1
                text_size: self.size
                halign: 'center'
                valign: 'middle'
                canvas.before:
                    Color:
                        rgba: 0.1, 0.15, 0.1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
        
        # Loading
        ProgressBar:
            id: loading_bar
            size_hint_y: None
            height: dp(5)
            max: 100
            value: 0
            opacity: 0
        
        # Action Buttons - 增大高度
        BoxLayout:
            size_hint_y: None
            height: dp(70)
            spacing: dp(20)
            
            Button:
                text: '拍照'
                font_name: 'Chinese'
                on_release: root.capture_photo()
                background_color: 0.2, 0.6, 1, 1
                font_size: '22sp'
            
            Button:
                text: '提交'
                font_name: 'Chinese'
                on_release: root.submit_sign()
                background_color: 0.2, 0.8, 0.2, 1
                font_size: '22sp'


<SettingsScreen>:
    name: 'settings'
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(30)
        
        Label:
            text: '设置'
            font_name: 'Chinese'
            font_size: '22sp'
            size_hint_y: None
            height: dp(70)
            text_size: self.size
            halign: 'center'
            valign: 'middle'
            canvas.before:
                Color:
                    rgba: 0.2, 0.2, 0.2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
        
        Label:
            text: '服务器地址:'
            font_name: 'Chinese'
            font_size: '18sp'
            size_hint_y: None
            height: dp(60)
            text_size: self.size
            halign: 'left'
            valign: 'middle'
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
        
        TextInput:
            id: api_url_input
            hint_text: 'http://192.168.100.100:8099'
            font_size: '16sp'
            multiline: False
            size_hint_y: None
            height: dp(70)
        
        Label:
            id: validation_label
            text: ''
            font_name: 'Chinese'
            font_size: '16sp'
            size_hint_y: None
            height: dp(60)
            color: 1, 0, 0, 1
            text_size: self.size
            halign: 'center'
            valign: 'middle'
            canvas.before:
                Color:
                    rgba: 0.1, 0.1, 0.1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
        
        Widget:
            size_hint_y: 0.1
        
        Button:
            text: '测试连接'
            font_name: 'Chinese'
            font_size: '20sp'
            size_hint_y: None
            height: dp(70)
            on_release: root.test_connection()
            background_color: 0.2, 0.6, 1, 1
        
        BoxLayout:
            size_hint_y: None
            height: dp(70)
            spacing: dp(30)
            
            Button:
                text: '保存'
                font_name: 'Chinese'
                font_size: '20sp'
                on_release: root.save_config()
                background_color: 0.2, 0.8, 0.2, 1
            
            Button:
                text: '返回'
                font_name: 'Chinese'
                font_size: '20sp'
                on_release: app.root.current = 'main'
                background_color: 0.5, 0.5, 0.5, 1
